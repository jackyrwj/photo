<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±åº¦è¯Šæ–­ - å¤„ç†å¤±è´¥æ’æŸ¥</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #0d1117;
        }
        h1 {
            color: #58a6ff;
            margin: 20px 0 10px;
            border-bottom: 2px solid #30363d;
            padding-bottom: 10px;
        }
        h2 {
            color: #79c0ff;
            font-size: 16px;
            margin: 15px 0 8px;
        }
        .section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .test-btn {
            background: #238636;
            color: #fff;
            border: 1px solid #2ea043;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-family: inherit;
            font-weight: bold;
        }
        .test-btn:hover { background: #2ea043; }
        .test-btn:active { transform: scale(0.98); }
        .log {
            background: #010409;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.5;
        }
        .log-line {
            padding: 2px 0;
            margin: 2px 0;
            border-radius: 3px;
            padding-left: 8px;
        }
        .log-error {
            background: #3d2626;
            color: #f85149;
            border-left: 3px solid #f85149;
        }
        .log-success {
            background: #1a3a1a;
            color: #3fb950;
            border-left: 3px solid #3fb950;
        }
        .log-info {
            background: #1c2d3d;
            color: #58a6ff;
            border-left: 3px solid #58a6ff;
        }
        .log-warn {
            background: #3d3d26;
            color: #d29922;
            border-left: 3px solid #d29922;
        }
        input[type="file"] { display: none; }
        .file-info {
            background: #010409;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 13px;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 0 4px;
        }
        .status.ok {
            background: #238636;
            color: #fff;
        }
        .status.error {
            background: #da3633;
            color: #fff;
        }
        .step {
            background: #0d1117;
            border-left: 4px solid #58a6ff;
            padding: 12px;
            margin: 10px 0;
        }
        .step-title {
            color: #58a6ff;
            font-weight: bold;
            margin-bottom: 6px;
        }
        .step-desc {
            color: #8b949e;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ·±åº¦è¯Šæ–­ - å¤„ç†å¤±è´¥æ’æŸ¥</h1>
        
        <div class="section">
            <h2>ğŸ“‹ å¿«é€Ÿæ£€æŸ¥</h2>
            <button class="test-btn" onclick="runQuickCheck()">è¿è¡Œå¿«é€Ÿæ£€æŸ¥</button>
            <button class="test-btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <div class="log" id="quickLog"></div>
        </div>

        <div class="section">
            <h2>ğŸ”§ è¯¦ç»†è¯Šæ–­</h2>
            <button class="test-btn" onclick="testImageUpload()">æµ‹è¯•æ–‡ä»¶ä¸Šä¼ </button>
            <button class="test-btn" onclick="testCanvasProcessing()">æµ‹è¯• Canvas å¤„ç†</button>
            <button class="test-btn" onclick="testColorParsing()">æµ‹è¯•é¢œè‰²è§£æ</button>
            <button class="test-btn" onclick="testBlobCreation()">æµ‹è¯• Blob åˆ›å»º</button>
            <input type="file" id="testFile" accept="image/*">
            <button class="test-btn" onclick="document.getElementById('testFile').click()">é€‰æ‹©å›¾ç‰‡æµ‹è¯•</button>
            <div class="log" id="detailLog"></div>
        </div>

        <div class="section">
            <h2>ğŸ“Š å¤„ç†æµç¨‹è¿½è¸ª</h2>
            <button class="test-btn" onclick="testFullPipeline()">å®Œæ•´å¤„ç†æµç¨‹æµ‹è¯•</button>
            <div class="log" id="pipelineLog"></div>
        </div>

        <div class="section">
            <h2>ğŸ’¡ è°ƒè¯•æ­¥éª¤</h2>
            <div class="step">
                <div class="step-title">ç¬¬1æ­¥ï¼šå¿«é€Ÿæ£€æŸ¥</div>
                <div class="step-desc">ç‚¹å‡»"è¿è¡Œå¿«é€Ÿæ£€æŸ¥"éªŒè¯æµè§ˆå™¨æ”¯æŒ</div>
            </div>
            <div class="step">
                <div class="step-title">ç¬¬2æ­¥ï¼šé€‰æ‹©å›¾ç‰‡</div>
                <div class="step-desc">ç‚¹å‡»"é€‰æ‹©å›¾ç‰‡æµ‹è¯•"ä¸Šä¼ ä¸€å¼ å°è¯ä»¶ç…§</div>
            </div>
            <div class="step">
                <div class="step-title">ç¬¬3æ­¥ï¼šè¿è¡Œå®Œæ•´æµ‹è¯•</div>
                <div class="step-desc">ç‚¹å‡»"å®Œæ•´å¤„ç†æµç¨‹æµ‹è¯•"æ¨¡æ‹Ÿå®Œæ•´å¤„ç†</div>
            </div>
            <div class="step">
                <div class="step-title">ç¬¬4æ­¥ï¼šæ£€æŸ¥æ—¥å¿—</div>
                <div class="step-desc">æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯ï¼Œæ‰¾å‡ºé—®é¢˜æ‰€åœ¨</div>
            </div>
        </div>
    </div>

    <script>
        let testFile = null;
        let logs = {
            quick: [],
            detail: [],
            pipeline: []
        };

        function log(type, message, category = 'detail') {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${message}`;
            logs[category].push({ message: line, type });
            renderLogs(category);
        }

        function renderLogs(category) {
            const logEl = document.getElementById(`${category}Log`);
            logEl.innerHTML = logs[category].map(l => 
                `<div class="log-line log-${l.type}">${l.message}</div>`
            ).join('');
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLogs() {
            logs = { quick: [], detail: [], pipeline: [] };
            ['quick', 'detail', 'pipeline'].forEach(c => renderLogs(c));
        }

        // å¿«é€Ÿæ£€æŸ¥
        function runQuickCheck() {
            logs.quick = [];
            const checks = [
                ['Canvas API', () => !!document.createElement('canvas').getContext('2d')],
                ['Canvas willReadFrequently', () => {
                    const c = document.createElement('canvas');
                    const ctx = c.getContext('2d', { willReadFrequently: true });
                    return !!ctx;
                }],
                ['FileReader API', () => typeof FileReader !== 'undefined'],
                ['Blob API', () => typeof Blob !== 'undefined'],
                ['URL.createObjectURL', () => typeof URL.createObjectURL === 'function'],
                ['Image API', () => typeof Image !== 'undefined'],
                ['requestAnimationFrame', () => typeof requestAnimationFrame === 'function'],
                ['Uint8Array', () => typeof Uint8Array !== 'undefined'],
                ['Promise', () => typeof Promise !== 'undefined'],
            ];

            let allPass = true;
            for (const [name, test] of checks) {
                try {
                    const result = test();
                    if (result) {
                        log('success', `âœ“ ${name}`, 'quick');
                    } else {
                        log('error', `âœ— ${name} - è¿”å› false`, 'quick');
                        allPass = false;
                    }
                } catch (e) {
                    log('error', `âœ— ${name} - ${e.message}`, 'quick');
                    allPass = false;
                }
            }

            if (allPass) {
                log('success', 'âœ“ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œæµè§ˆå™¨æ”¯æŒå®Œæ•´', 'quick');
            } else {
                log('warn', 'âš  æŸäº›åŠŸèƒ½ä¸æ”¯æŒï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Firefox', 'quick');
            }
        }

        // æ–‡ä»¶ä¸Šä¼ æµ‹è¯•
        document.getElementById('testFile').addEventListener('change', (e) => {
            testFile = e.target.files[0];
            if (testFile) {
                log('info', `æ–‡ä»¶é€‰æ‹©: ${testFile.name}`, 'detail');
                log('info', `å¤§å°: ${(testFile.size / 1024).toFixed(2)} KB`, 'detail');
                log('info', `ç±»å‹: ${testFile.type}`, 'detail');
                
                if (!testFile.type.startsWith('image/')) {
                    log('error', 'âœ— ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶', 'detail');
                } else {
                    log('success', 'âœ“ æ–‡ä»¶æ ¼å¼æ­£ç¡®', 'detail');
                }
            }
        });

        function testImageUpload() {
            if (!testFile) {
                log('error', 'æœªé€‰æ‹©æ–‡ä»¶ï¼Œè¯·å…ˆç‚¹å‡»"é€‰æ‹©å›¾ç‰‡æµ‹è¯•"', 'detail');
                return;
            }

            log('info', 'å¼€å§‹æ–‡ä»¶è¯»å–æµ‹è¯•...', 'detail');
            const reader = new FileReader();

            reader.onerror = (error) => {
                log('error', `âœ— FileReader é”™è¯¯: ${error}`, 'detail');
            };

            reader.onload = (e) => {
                log('success', 'âœ“ FileReader è¯»å–æˆåŠŸ', 'detail');
                log('info', `æ•°æ®é•¿åº¦: ${e.target.result.length} å­—ç¬¦`, 'detail');

                const img = new Image();
                
                img.onerror = () => {
                    log('error', 'âœ— å›¾ç‰‡åŠ è½½å¤±è´¥ - æ•°æ®æ ¼å¼é”™è¯¯', 'detail');
                };

                img.onload = () => {
                    log('success', 'âœ“ å›¾ç‰‡åŠ è½½æˆåŠŸ', 'detail');
                    log('info', `å°ºå¯¸: ${img.width}x${img.height} åƒç´ `, 'detail');
                    log('info', `é¢ç§¯: ${(img.width * img.height / 1000000).toFixed(2)} ç™¾ä¸‡åƒç´ `, 'detail');
                };

                img.src = e.target.result;
            };

            reader.readAsDataURL(testFile);
        }

        function testCanvasProcessing() {
            if (!testFile) {
                log('error', 'æœªé€‰æ‹©æ–‡ä»¶', 'detail');
                return;
            }

            log('info', 'å¼€å§‹ Canvas å¤„ç†æµ‹è¯•...', 'detail');
            const reader = new FileReader();

            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        log('success', 'âœ“ Canvas åˆ›å»ºæˆåŠŸ', 'detail');

                        const ctx = canvas.getContext('2d', { willReadFrequently: true });
                        if (!ctx) throw new Error('æ— æ³•è·å– Context');
                        log('success', 'âœ“ Canvas Context è·å–æˆåŠŸ', 'detail');

                        ctx.drawImage(img, 0, 0);
                        log('success', 'âœ“ å›¾ç‰‡ç»˜åˆ¶åˆ° Canvas', 'detail');

                        const start = performance.now();
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const end = performance.now();
                        log('success', `âœ“ getImageData æˆåŠŸï¼Œè€—æ—¶ ${(end - start).toFixed(0)}ms`, 'detail');
                        log('info', `æ•°æ®å¤§å°: ${(imageData.data.length / 1024 / 1024).toFixed(2)} MB`, 'detail');

                        canvas.toBlob((blob) => {
                            if (!blob) {
                                log('error', 'âœ— toBlob è¿”å›ç©º', 'detail');
                            } else {
                                log('success', `âœ“ toBlob æˆåŠŸï¼Œå¤§å° ${(blob.size / 1024).toFixed(2)} KB`, 'detail');
                            }
                        });
                    } catch (e) {
                        log('error', `âœ— Canvas å¤„ç†å¤±è´¥: ${e.message}`, 'detail');
                    }
                };
                img.src = e.target.result;
            };

            reader.readAsDataURL(testFile);
        }

        function testColorParsing() {
            log('info', 'æµ‹è¯•é¢œè‰²è§£æ...', 'detail');
            const colors = ['#ffffff', '#2196F3', '#ff0000', '#000000', '#123abc'];

            for (const hex of colors) {
                try {
                    const h = hex.replace('#', '');
                    const r = parseInt(h.substring(0, 2), 16);
                    const g = parseInt(h.substring(2, 4), 16);
                    const b = parseInt(h.substring(4, 6), 16);

                    if (isNaN(r) || isNaN(g) || isNaN(b)) {
                        log('error', `âœ— ${hex} è§£æå¤±è´¥ - NaN`, 'detail');
                    } else {
                        log('success', `âœ“ ${hex} = RGB(${r}, ${g}, ${b})`, 'detail');
                    }
                } catch (e) {
                    log('error', `âœ— ${hex} å¼‚å¸¸: ${e.message}`, 'detail');
                }
            }
        }

        function testBlobCreation() {
            log('info', 'æµ‹è¯• Blob åˆ›å»º...', 'detail');
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#2196F3';
                ctx.fillRect(0, 0, 100, 100);
                log('success', 'âœ“ åˆ›å»ºæµ‹è¯•ç”»å¸ƒ', 'detail');

                canvas.toBlob((blob) => {
                    if (!blob) {
                        log('error', 'âœ— toBlob è¿”å› null', 'detail');
                    } else {
                        log('success', `âœ“ Blob åˆ›å»ºæˆåŠŸ: ${(blob.size / 1024).toFixed(2)} KB`, 'detail');
                        
                        const url = URL.createObjectURL(blob);
                        log('success', `âœ“ åˆ›å»ºå¯¹è±¡ URL: ${url.substring(0, 50)}...`, 'detail');
                    }
                }, 'image/png', 0.95);
            } catch (e) {
                log('error', `âœ— Blob æµ‹è¯•å¤±è´¥: ${e.message}`, 'detail');
            }
        }

        function testFullPipeline() {
            if (!testFile) {
                log('error', 'æœªé€‰æ‹©æ–‡ä»¶', 'pipeline');
                return;
            }

            logs.pipeline = [];
            log('info', '========== å®Œæ•´å¤„ç†æµç¨‹å¼€å§‹ ==========', 'pipeline');

            const reader = new FileReader();
            let stepCount = 0;

            reader.onerror = (err) => {
                log('error', `âœ— æ­¥éª¤${++stepCount}: FileReader é”™è¯¯ - ${err}`, 'pipeline');
            };

            reader.onload = (e) => {
                log('success', `âœ“ æ­¥éª¤${++stepCount}: FileReader è¯»å–æˆåŠŸ`, 'pipeline');

                const img = new Image();
                
                img.onerror = () => {
                    log('error', `âœ— æ­¥éª¤${++stepCount}: å›¾ç‰‡åŠ è½½å¤±è´¥`, 'pipeline');
                };

                img.onload = () => {
                    log('success', `âœ“ æ­¥éª¤${++stepCount}: å›¾ç‰‡åŠ è½½æˆåŠŸ (${img.width}x${img.height})`, 'pipeline');

                    requestAnimationFrame(() => {
                        try {
                            const startTime = performance.now();
                            
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            log('success', `âœ“ æ­¥éª¤${++stepCount}: Canvas åˆ›å»ºæˆåŠŸ`, 'pipeline');

                            const ctx = canvas.getContext('2d', { willReadFrequently: true });
                            if (!ctx) throw new Error('Context ä¸º null');
                            log('success', `âœ“ æ­¥éª¤${++stepCount}: è·å– Canvas Context`, 'pipeline');

                            ctx.drawImage(img, 0, 0);
                            log('success', `âœ“ æ­¥éª¤${++stepCount}: ç»˜åˆ¶å›¾ç‰‡åˆ° Canvas`, 'pipeline');

                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;
                            log('success', `âœ“ æ­¥éª¤${++stepCount}: è·å–å›¾åƒæ•°æ®`, 'pipeline');

                            // æ¨¡æ‹ŸèƒŒæ™¯æ£€æµ‹
                            const corners = [
                                { x: 0, y: 0 },
                                { x: canvas.width - 1, y: 0 },
                                { x: 0, y: canvas.height - 1 },
                                { x: canvas.width - 1, y: canvas.height - 1 }
                            ];
                            let sumR = 0, sumG = 0, sumB = 0;
                            for (const c of corners) {
                                const idx = (c.y * canvas.width + c.x) * 4;
                                sumR += data[idx];
                                sumG += data[idx + 1];
                                sumB += data[idx + 2];
                            }
                            const bgR = Math.round(sumR / 4);
                            const bgG = Math.round(sumG / 4);
                            const bgB = Math.round(sumB / 4);
                            log('success', `âœ“ æ­¥éª¤${++stepCount}: æ£€æµ‹èƒŒæ™¯è‰² RGB(${bgR}, ${bgG}, ${bgB})`, 'pipeline');

                            // é¢œè‰²æ›¿æ¢
                            const targetR = 33, targetG = 150, targetB = 243;
                            let replacedCount = 0;
                            for (let i = 0; i < data.length; i += 4) {
                                const diff = Math.sqrt(
                                    (data[i] - bgR) ** 2 +
                                    (data[i + 1] - bgG) ** 2 +
                                    (data[i + 2] - bgB) ** 2
                                );
                                if (diff < 35) {
                                    data[i] = targetR;
                                    data[i + 1] = targetG;
                                    data[i + 2] = targetB;
                                    replacedCount++;
                                }
                            }
                            log('success', `âœ“ æ­¥éª¤${++stepCount}: æ›¿æ¢é¢œè‰² (${replacedCount} åƒç´ )`, 'pipeline');

                            ctx.putImageData(imageData, 0, 0);
                            log('success', `âœ“ æ­¥éª¤${++stepCount}: å†™å…¥å¤„ç†åçš„æ•°æ®`, 'pipeline');

                            canvas.toBlob((blob) => {
                                if (!blob) {
                                    log('error', `âœ— æ­¥éª¤${++stepCount}: toBlob è¿”å›ç©º`, 'pipeline');
                                    return;
                                }
                                log('success', `âœ“ æ­¥éª¤${++stepCount}: è½¬æ¢ä¸º Blob (${(blob.size / 1024).toFixed(2)} KB)`, 'pipeline');

                                const url = URL.createObjectURL(blob);
                                log('success', `âœ“ æ­¥éª¤${++stepCount}: åˆ›å»ºå¯¹è±¡ URL`, 'pipeline');

                                const endTime = performance.now();
                                log('success', `âœ“ æ­¥éª¤${++stepCount}: å¤„ç†å®Œæˆï¼Œæ€»è€—æ—¶ ${(endTime - startTime).toFixed(0)}ms`, 'pipeline');

                                log('info', '========== å¤„ç†æµç¨‹æˆåŠŸ ==========', 'pipeline');
                            }, 'image/png', 0.95);

                        } catch (e) {
                            log('error', `âœ— æ­¥éª¤${++stepCount}: ${e.message}`, 'pipeline');
                            log('info', '========== å¤„ç†æµç¨‹å¤±è´¥ ==========', 'pipeline');
                        }
                    });
                };

                img.src = e.target.result;
            };

            reader.readAsDataURL(testFile);
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            runQuickCheck();
        });
    </script>
</body>
</html>
